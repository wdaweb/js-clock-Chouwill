<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px;
        background: url("./imgs//forest-bg.jpg") no-repeat;
        background-size: cover;
        background-position: center;
      }

      .hammer img {
        width: 250px;
        height: 250px;
        transform: rotate(10deg);
      }

      .clock {
        width: 500px;
        height: 500px;
        border-radius: 100%;
        position: relative;
        background-image: url("./imgs/clock-bg.png");
        background-repeat: no-repeat;
        background-size: cover;
      }

      p {
        color: #000;
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: 0 0;
        transform: rotate(30deg) translate(100px);
        font-size: 30px;
      }

      .clock p:nth-of-type(1) {
        transform: rotate(295deg) translate(270px) rotate(-295deg);
      }
      .clock p:nth-of-type(2) {
        transform: rotate(320deg) translate(250px) rotate(-320deg);
      }
      .clock p:nth-of-type(3) {
        transform: rotate(-10deg) translate(230px) rotate(10deg);
      }
      .clock p:nth-of-type(4) {
        transform: rotate(20deg) translate(210px) rotate(-20deg);
      }
      .clock p:nth-of-type(5) {
        transform: rotate(50deg) translate(185px) rotate(-50deg);
      }
      .clock p:nth-of-type(6) {
        transform: rotate(90deg) translate(180px) rotate(-90deg);
      }
      .clock p:nth-of-type(7) {
        transform: rotate(130deg) translate(190px) rotate(-130deg);
      }
      .clock p:nth-of-type(8) {
        transform: rotate(160deg) translate(210px) rotate(-160deg);
      }
      .clock p:nth-of-type(9) {
        transform: rotate(190deg) translate(235px) rotate(-190deg);
      }
      .clock p:nth-of-type(10) {
        transform: rotate(220deg) translate(255px) rotate(-220deg);
      }
      .clock p:nth-of-type(11) {
        transform: rotate(245deg) translate(275px) rotate(-245deg);
      }
      .clock p:nth-of-type(12) {
        transform: rotate(270deg) translate(285px) rotate(-270deg);
        font-size: 40px;
      }

      .circle {
        width: 20px;
        height: 20px;
        background-color: #000;
        border-radius: 50%;
        position: absolute;
        top: 246px;
        left: 244px;
      }

      .minute-line,
      .hour-line,
      .second-line {
        height: 3px;
        border-radius: 10px;
        position: absolute;
        top: 256px;
        left: 254px;
        transform-origin: left center; /* 旋轉中心設在左側，這樣才會以時鐘中心為軸心 */
      }

      .minute-line {
        width: 170px;
        background-color: #000;
      }

      .hour-line {
        width: 130px;
        background-color: #d20d0d;
      }

      .second-line {
        width: 180px;
        background-color: green;
      }

      .set-alarm {
        margin: 35px 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .set-alarm label {
        color: #fff;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .set-alarm input[type="datetime-local"] {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      .set-alarm input[type="button"] {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .set-alarm input[type="button"]:hover {
        background-color: #45a049;
      }

      .set-alarm input[type="button"]:active {
        background-color: #3d8b40;
      }

      .show-now-time {
        margin: 20px 0;
      }

      .showTimeText {
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        font-size: 24px;
        text-align: center;
      }

      .alarm-success {
        color: #4CAF50;
        font-weight: bold;
        margin-top: 10px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s;
      }

      .alarm-success.show {
        opacity: 1;
      }

      .brick {
        position: relative;
        width: 250px;
        height: 250px;
        overflow: visible;
        z-index: 10;
      }

      .brick img {
        display: block;
        width: 250px;
        height: 250px;
        opacity: 0;
        transform: translateY(100%) scaleX(-1) scale(0.5);
        pointer-events: none;
      }

      @keyframes bearPopUp {
        0% {
          transform: translateY(100%) scaleX(-1) scale(0.5);
          opacity: 0;
        }
        50% {
          transform: translateY(0) scaleX(-1) scale(1.1);
          opacity: 1;
        }
        100% {
          transform: translateY(0) scaleX(-1) scale(1);
          opacity: 1;
        }
      }

      @keyframes bearFadeOut {
        0% {
          transform: translateY(0) scaleX(-1) scale(1);
          opacity: 1;
        }
        100% {
          transform: translateY(-50%) scaleX(-1) scale(0.8);
          opacity: 0;
        }
      }

      .bear.show {
        opacity: 1;
        pointer-events: auto;
        animation: bearPopUp 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      }

      .bear.hide {
        animation: bearFadeOut 0.5s ease-in forwards;
      }

      @keyframes clockShake {
        0%, 100% {
          transform: translateX(0);
        }
        10%, 30%, 50%, 70%, 90% {
          transform: translateX(-10px) rotate(-2deg);
        }
        20%, 40%, 60%, 80% {
          transform: translateX(10px) rotate(2deg);
        }
      }

      .clock.alarm-ringing {
        animation: clockShake 0.5s ease-in-out infinite;
      }

      @keyframes hammer {
        0% {
          transform: translateY(-150px) rotate(0deg);
        }
        100% {
          transform: translateY(130vh) rotate(-360deg);
        }
      }

      .hammer-img {
        display: block;
        animation: hammer 2s linear infinite;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="hammer">
        <!-- <img class="hammer-img" src="./imgs/hammer.png" alt="" /> -->
      </div>

      <div class="clock">
        <div class="circle"></div>
        <div class="hour-line"></div>
        <div class="minute-line"></div>
        <div class="second-line"></div>
      </div>

      <div class="show-now-time">
        <h2 class="showTimeText"></h2>
      </div>

      <div class="set-alarm">
        <label>設定鬧鐘</label>
        <input type="datetime-local" class="dateTime" />
        <input type="button" value="設定" class="setButton" />
        <div class="alarm-success">✓ 鬧鐘已設定</div>
      </div>

      <div class="brick">
        <img class="bear" src="./imgs/Bear.png" alt="鬧鐘熊" />
      </div>

      <!-- <button class="bearBtn">切換熊熊顯示狀態</button> -->
    </div>

    <!-- dayjs -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <script>
      const clock = document.querySelector(".clock");
      const hourLine = document.querySelector(".hour-line");
      const minuteLine = document.querySelector(".minute-line");
      const secondLine = document.querySelector(".second-line");
      const showTimeText = document.querySelector(".showTimeText");
      const dateTime = document.querySelector(".dateTime");
      const setButton = document.querySelector(".setButton");
      const alarmSuccess = document.querySelector(".alarm-success");
      const switchBear = document.querySelector(".bearBtn");
      const Bear = document.querySelector(".bear");
      let alarmRinging = false;

      function initDateTimeInput() {
        const now = dayjs();
        dateTime.value = now.format("YYYY-MM-DDTHH:mm");
      }

      initDateTimeInput();

      function generateClockNumbers() {
        for (let i = 1; i <= 12; i++) {
          const clockNum = document.createElement("p");
          clockNum.innerText = i;
          // clock.appendChild(clockNum);
        }
      }

      generateClockNumbers();

      function checkAlarm() {
        const setTimeStr = localStorage.getItem("setTime");
        if (!setTimeStr) return;

        if (alarmRinging) return; // 防止同一分鐘內重複觸發

        try {
          const setTime = dayjs(setTimeStr);
          const now = dayjs();

          // 比較到分鐘就好，秒數忽略
          if (
            setTime.year() === now.year() &&
            setTime.month() === now.month() &&
            setTime.date() === now.date() &&
            setTime.hour() === now.hour() &&
            setTime.minute() === now.minute()
          ) {
            triggerAlarm();
          }
        } catch (error) {
          // localStorage 資料可能被手動改過，格式不對會報錯
          console.error("鬧鐘時間格式錯誤:", error);
          localStorage.removeItem("setTime");
        }
      }

      function triggerAlarm() {
        alarmRinging = true;

        clock.classList.add("alarm-ringing");

        if (Bear) {
          Bear.classList.remove("hide");
          Bear.classList.add("show");
        }

        setTimeout(() => {
          if (Bear) {
            Bear.classList.remove("show");
            Bear.classList.add("hide");
          }
          clock.classList.remove("alarm-ringing");

          localStorage.removeItem("setTime");
          alarmSuccess.classList.remove("show");

          setTimeout(() => {
            alarmRinging = false;
            if (Bear) {
              Bear.classList.remove("hide");
            }
          }, 500); // 等動畫完成
        }, 3500); // 3.5 秒後消失
      }

      setButton.addEventListener("click", () => {
        const selectedTime = dateTime.value;
        if (!selectedTime) {
          alert("請選擇鬧鐘時間");
          return;
        }

        const setTime = dayjs(selectedTime);
        const now = dayjs();

        if (setTime.isBefore(now)) {
          alert("請選擇未來的時間");
          return;
        }

        localStorage.setItem("setTime", selectedTime);
        alarmSuccess.classList.add("show");
        setTimeout(() => {
          alarmSuccess.classList.remove("show");
        }, 3000);
      });

      if (Bear) {
        setInterval(() => {
          Bear.style.display = "block";
          Bear.style.transform = "scaleX(1)";
        }, 2000);
      }

      function updateClock() {
        const now = dayjs();

        const hours24 = now.hour();
        const hours12 = hours24 % 12 || 12; // 0 時顯示為 12
        const minutes = now.minute();
        const seconds = now.second();

        // 時針要考慮分鐘數的影響，每分鐘移動 0.5 度
        const hourAngle = hours12 * 30 + minutes * 0.5 - 90; // 減 90 是因為 CSS 0 度是向右，12 點要向上
        const minuteAngle = minutes * 6 - 90;
        const secondAngle = seconds * 6 - 90;

        hourLine.style.transform = `rotate(${hourAngle}deg)`;
        minuteLine.style.transform = `rotate(${minuteAngle}deg)`;
        secondLine.style.transform = `rotate(${secondAngle}deg)`;

        showTimeText.innerHTML =
          `${now.format("YYYY年MM月DD日")} ` +
          `${now.format("HH:mm:ss")}`;

        checkAlarm();
      }

      updateClock(); // 先執行一次，避免載入時延遲
      setInterval(updateClock, 1000);
    </script>
  </body>
</html>
